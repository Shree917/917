/* =========================================================
   MEDICAL DB: Schema, data, and all required queries
   MySQL/InnoDB; uses ON DELETE CASCADE on Treats FKs
   ========================================================= */

-- 0) Start clean (optional for a scratch DB)
DROP DATABASE IF EXISTS medical_db;
CREATE DATABASE medical_db;
USE medical_db;

-- 1) Create tables with proper keys & constraints
--    Note: VARCHAR sizes are generous; adjust as needed.

CREATE TABLE Patient (
  pat_id       VARCHAR(10)  PRIMARY KEY,
  pat_name     VARCHAR(50)  NOT NULL,
  DateOfAdmit  DATE         NOT NULL,
  age          INT          NOT NULL,
  city         VARCHAR(50)  NOT NULL
) ENGINE=InnoDB;

CREATE TABLE Doctor (
  doc_id        VARCHAR(10)  PRIMARY KEY,
  doc_name      VARCHAR(50)  NOT NULL,
  qualification VARCHAR(20)  NOT NULL,
  experience    INT          NOT NULL,
  dept          VARCHAR(50)  NOT NULL,
  city          VARCHAR(50)  NOT NULL,
  salary        INT          NOT NULL
) ENGINE=InnoDB;

-- Treats references both Doctor and Patient.
-- ON DELETE CASCADE ensures if a Patient/Doctor is deleted,
-- related Treats rows vanish automatically.
CREATE TABLE Treats (
  doc_id  VARCHAR(10) NOT NULL,
  pat_id  VARCHAR(10) NOT NULL,
  disease VARCHAR(50) NOT NULL,
  PRIMARY KEY (doc_id, pat_id, disease),
  CONSTRAINT fk_treats_doc
    FOREIGN KEY (doc_id) REFERENCES Doctor(doc_id)
    ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_treats_pat
    FOREIGN KEY (pat_id) REFERENCES Patient(pat_id)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

-- 1) Insert at least 5 records in each table
-- Patient data as per the example (ids, names, dates, ages, cities)
INSERT INTO Patient (pat_id, pat_name, DateOfAdmit, age, city) VALUES
('a10','Aryan','2017-05-11',20,'Mumbai'),
('c12','Amit','2017-07-21',39,'Bangalore'),
('d13','Anita','2017-09-25',49,'Pune'),
('p10','Sandesh','2016-07-21',28,'Pune'),
('x15','Suyash','2017-04-17',29,'Delhi');

-- Doctor data (note the typos “Chemothera” and “Mumabi” kept to match the sample outputs)
INSERT INTO Doctor (doc_id, doc_name, qualification, experience, dept, city, salary) VALUES
('e1','Suhas','MD',10,'Dental','Pune',70000),
('r5','Yogesh','MD',8,'Dental','Delhi',40000),
('s5','Mangesh','MBBS',25,'Cardiology','Bangalore',100000),
('w8','Komal','MBBS',25,'Chemothera','Kolkata',45000),
('y3','Shubham','MBBS',10,'Cardiology','Mumabi',60000);

-- Treats data
INSERT INTO Treats (doc_id, pat_id, disease) VALUES
('w8','p10','Cancer'),
('w8','c12','Cancer'),
('e1','d13','Toothache'),
('s5','x15','Heart Attack'),
('r5','a10','Cavities');

-- Verify initial data (optional)
SELECT * FROM Patient;
SELECT * FROM Doctor;
SELECT * FROM Treats;

-- 2) Display all the patient names between age group 18 to 50.
SELECT pat_name
FROM Patient
WHERE age BETWEEN 18 AND 50;

-- 3) Display the list of all doctors who are MD.
SELECT doc_name
FROM Doctor
WHERE qualification = 'MD';

-- 4) Display the list of all doctors whose experience > 20 years.
SELECT doc_name
FROM Doctor
WHERE experience > 20;

-- 5) Display patient names suffering from cancer.
-- (Join Patient ↔ Treats on pat_id + filter disease)
SELECT p.pat_name
FROM Patient AS p
JOIN Treats  AS t ON t.pat_id = p.pat_id
WHERE t.disease = 'Cancer';

-- 6) Display the patient name & doctor name who is treating the cancer patient.
SELECT p.pat_name, d.doc_name
FROM Patient AS p
JOIN Treats  AS t ON t.pat_id = p.pat_id
JOIN Doctor  AS d ON d.doc_id = t.doc_id
WHERE t.disease = 'Cancer';

-- 7) Names starting with 'a', ending with 'a', and exactly 5 letters
-- a) starts with 'a' (case-sensitive depending on collation)
SELECT pat_name FROM Patient WHERE pat_name LIKE 'a%';
-- b) ends with 'a'
SELECT pat_name FROM Patient WHERE pat_name LIKE '%a';
-- c) exactly 5 letters
SELECT pat_name FROM Patient WHERE pat_name LIKE '_____';

-- 8) Remove all the records of patient with patient_id = 'p10'.
--     Related Treats rows (for p10) will be auto-deleted due to cascade.
DELETE FROM Patient WHERE pat_id = 'p10';
SELECT * FROM Patient;
SELECT * FROM Treats;

-- 9) Remove all the records of doctor Suhas (doc_name = 'Suhas').
--    Cascades remove Suhas’s Treats rows.
DELETE FROM Doctor WHERE doc_name = 'Suhas';
SELECT * FROM Treats;
SELECT * FROM Doctor;

-- 10) Change the qualification of doctor Shubham from MBBS to MD.
UPDATE Doctor
SET qualification = 'MD'
WHERE doc_name = 'Shubham';
SELECT * FROM Doctor;

-- 11) Give 5% raise to Dental and 10% to Cardiology (single query).
UPDATE Doctor
SET salary = CASE
  WHEN dept = 'Dental'     THEN salary + salary * 0.05
  WHEN dept = 'Cardiology' THEN salary + salary * 0.10
  ELSE salary
END;
SELECT * FROM Doctor;

-- 12) Dept-wise total salary of doctors.
SELECT dept, SUM(salary) AS total_salary
FROM Doctor
GROUP BY dept;

-- 13) Dept that has the highest average salary.
SELECT dept, AVG(salary) AS avg_salary
FROM Doctor
GROUP BY dept
HAVING AVG(salary) >= ALL (
  SELECT AVG(salary) FROM Doctor GROUP BY dept
);

-- 14) Average salary of the doctors in Dental dept.
SELECT AVG(salary) AS avg_salary
FROM Doctor
WHERE dept = 'Dental';

-- 15) Depts where avg salary of the doctor is more than 50,000.
SELECT dept
FROM Doctor
GROUP BY dept
HAVING AVG(salary) > 50000;

-- 16) How many doctors work in the hospital.
SELECT COUNT(*) AS doctor_count
FROM Doctor;

-- 17) How many doctors actually treated a patient. (distinct doc_id in Treats)
SELECT COUNT(DISTINCT doc_id) AS active_doctors
FROM Treats;

-- 18) Cities in which either doctor or patient lives. (UNION removes duplicates)
SELECT city FROM Doctor
UNION
SELECT city FROM Patient;

-- 19) Cities in which both the patient & the doctor live.
-- DISTINCT avoids duplicates that can arise from the join.
SELECT DISTINCT d.city
FROM Doctor AS d
JOIN Patient AS p ON d.city = p.city;

-- 20) Doctors who have not treated any patient.
SELECT doc_name, doc_id
FROM Doctor
WHERE doc_id NOT IN (SELECT DISTINCT doc_id FROM Treats);
